{% extends 'base.html' %}

{% block title %}User Services{% endblock %}

{% block content %}
  <body class="bg-slate-100">
    <div class="flex items-center justify-center px-12">
      <div class="mt-12">
        <p class="text-4xl text-orange-600 font-bold mt-12 mb-4 float-left">List Of Users</p>
        <div class="float-right mt-14">
          <a href="{{ url_for('add_user') }}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Add New User</a>
        </div>
        <table class="bg-white shadow-md rounded-xl w-full">
          <thead>
            <tr class="bg-orange-600 text-white rounded-md">
              <th class="py-3 px-10 text-center">Last Name</th>
              <th class="py-3 text-center">First Name</th>
              <th class="py-3 text-center">Email</th>
              <th class="py-3 text-center">Role</th>
              <th class="py-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody class="text-blue-gray-900">
            {% for user in user %}
            <tr class="border-b border-blue-gray-200">
              <td class="py-3 px-10 text-center">{{ user['lname'] }}</td>
              <td class="py-3 text-center">{{ user['fname'] }}</td>
              <td class="py-3 text-center">{{ user['email'] }}</td>
              <td class="py-3 text-center">{{ user['role'] }}</td>
              <td class="py-3 text-center">
                <a href="{{ url_for('edit_user', user_id=user['_id']) }}" class="font-medium text-blue-600 hover:text-blue-800 px-2">Edit</a>
                <button onclick="confirmDelete('{{ user['_id'] }}')" class="font-medium text-red-600 hover:text-red-800 px-2">Delete</button>
                <input type="hidden" id="userId_{{ user['_id'] }}" value="{{ user['_id'] }}">
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal for confirming user deletion -->
    <div id="deleteUserModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
      <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 max-w-md m-auto rounded shadow-xl">
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Confirm User Deletion</h2>
          <p class="text-gray-700 mb-4">Are you sure you want to delete this user?</p>
          <div class="flex justify-end">
            <button onclick="cancelDelete()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 mr-2 rounded">No</button>
            <button onclick="deleteUser()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Yes</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Function to show the delete user modal
      function confirmDelete(userId) {
        // Get the user ID from the hidden input field
        var modal = document.getElementById("deleteUserModal");
        var userIdField = document.getElementById("userId_" + userId).value;

        // Set the user ID in the modal for reference
        modal.dataset.userId = userIdField;

        // Show the modal
        modal.classList.remove("hidden");
      }

      // Function to close the delete user modal without deleting the user
      function cancelDelete() {
        var modal = document.getElementById("deleteUserModal");
        modal.classList.add("hidden");
      }

      // Function to delete the user
      function deleteUser() {
        // Get the user ID from the modal
        var modal = document.getElementById("deleteUserModal");
        var userId = modal.dataset.userId;

        // Make an AJAX request to delete the user
        fetch(`/delete_user/${userId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to delete user');
          }
          return response.json();
        })
        .then(data => {
          alert(data.message);
          // Close the modal
          cancelDelete();
          // Optionally, refresh the user list or perform any other necessary actions
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to delete user');
        });
        location.reload();
      }
    </script>
  </body>
{% endblock %}
